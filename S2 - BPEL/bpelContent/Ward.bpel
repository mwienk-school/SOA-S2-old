<!-- Ward BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Mar 28 12:59:26 CEST 2012 -->
<bpel:process name="Ward" targetNamespace="http://www.PAHospital.org/WardService/"
	suppressJoinFailure="yes" xmlns:ward="http://www.PAHospital.org/WardService/"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:ts="http://www.PAHospital.org/TransportationService/" xmlns:lab="http://www.PAHospital.org/LabService/"
	xmlns:labcb="http://www.PAHospital.org/LabCallbackService/" xmlns:pat="http://www.PAHospital.org/PatService/"
	xmlns:rad="http://www.PAHospital.org/RadiologyService/" xmlns:radcb="http://www.PAHospital.org/RadiologyCallbackService/">

	<!-- Import the service WSDL -->
	<bpel:import location="WardArtifacts.wsdl"
		namespace="http://www.PAHospital.org/WardService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	        
	<!-- Import the PartnerLink WSDLs -->
	<bpel:import location="TranspService.wsdl"
		namespace="http://www.PAHospital.org/TransportationService/"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService.wsdl"
		namespace="http://www.PAHospital.org/LabService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService-callback.wsdl"
		namespace="http://www.PAHospital.org/LabCallbackService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="PatService.wsdl"
		namespace="http://www.PAHospital.org/PatService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService.wsdl"
		namespace="http://www.PAHospital.org/RadiologyService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService-callback.wsdl"
		namespace="http://www.PAHospital.org/RadiologyCallbackService/"
		importType="http://schemas.xmlsoap.org/wsdl/" />


	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:partnerLinks>
		<bpel:partnerLink name="WardService" partnerLinkType="ward:WardPLT"
			myRole="WardService" />
		<bpel:partnerLink name="TranspService"
			partnerLinkType="ward:TransportPLT" partnerRole="TransportService" />
		<bpel:partnerLink name="LabService" partnerLinkType="ward:LaboratoryPLT"
			partnerRole="LaboratoryService" myRole="LaboratoryRequester" />
		<bpel:partnerLink name="PatService" partnerLinkType="ward:PatientPLT"
			partnerRole="ElectronicPatientRecordService" />
		<bpel:partnerLink name="RadService" partnerLinkType="ward:RadiologyPLT"
			partnerRole="RadiologyService" myRole="RadiologyRequester" />
	</bpel:partnerLinks>

	<bpel:variables>
		<bpel:variable name="WardServiceRequest" messageType="ward:WardOrderPatientTreatmentRequest" />
		<bpel:variable name="GetPatientIDRequest" messageType="pat:GetPatientIDsRequest" />
		<bpel:variable name="GetPatientIDResponse" messageType="pat:GetPatientIDsResponse" />
		<bpel:variable name="OrderLabTestRequest" messageType="lab:LaboratoryOrderLabTestRequest" />
		<bpel:variable name="OrderLabTestResponse" messageType="lab:LaboratoryOrderLabTestResponse" />
		<bpel:variable name="LabSampleTransportRequest"	messageType="ts:OrderSampleTransportRequest" />
		<bpel:variable name="LabReportResponse" messageType="labcb:SendLabReportResponse" />
		<bpel:variable name="StoreLabReportRequest" messageType="pat:StoreLabReportRequest" />
		<bpel:variable name="OrderRadiologyExamRequest" messageType="rad:RadiologyOrderRadExaminationRequest" />
		<bpel:variable name="OrderRadiologyExamResponse" messageType="rad:RadiologyOrderRadExaminationResponse" />
		<bpel:variable name="RadiologyAppointmentRequest" messageType="rad:RadiologyRequestAppointmentRequest" />
		<bpel:variable name="RadiologyAppointmentResponse" messageType="rad:RadiologyRequestAppointmentResponse" />
		<bpel:variable name="RadPatientTransportRequest" messageType="ts:OrderPatientTransportRequest" />
		<bpel:variable name="RadiologyReportResponse" messageType="radcb:RadiologyReportRequest" />
		<bpel:variable name="StoreRadiologyReportRequest" messageType="pat:StoreRadiologyReportRequest" />
		<bpel:variable name="WardServiceResponse" messageType="ward:WardOrderPatientTreatmentResponse" />
		<bpel:variable name="CreatePatientResponse" messageType="pat:CreatePatientRecordResponse" />
		<bpel:variable name="CreatePatientRequest" messageType="pat:CreatePatientRecordRequest" />
        <bpel:variable name="WardServicePaymentRequest" messageType="ward:WardPaymentRequest" />
        <bpel:variable name="WardServiceReceiveDischargeLetter" messageType="ward:WardDischargeLetter" />
    </bpel:variables>
	
	<bpel:sequence name="main">
		<bpel:receive name="Receive-AdmissionOrder" partnerLink="WardService"
			operation="OrderPatientTreatment" variable="WardServiceRequest"
			createInstance="yes" />
		<bpel:assign validate="no" name="Assign-Patient">
			<bpel:copy>
				<bpel:from part="PatientTreatmentOrder" variable="WardServiceRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[PatientName]]>
					</bpel:query>
				</bpel:from>
				<bpel:to part="PatientName" variable="GetPatientIDRequest"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="PatientTreatmentOrder" variable="WardServiceRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
				</bpel:from>
				<bpel:to part="Patient" variable="CreatePatientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
				</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:invoke name="Invoke-GetPatientID" partnerLink="PatService"
			         operation="GetPatientIDsByName" inputVariable="GetPatientIDRequest"
			         outputVariable="GetPatientIDResponse" />
		<bpel:if name="If-PatientExists">
			<bpel:condition><![CDATA[number($GetPatientIDResponse.PatientIDsList/PatientID)]]></bpel:condition>
			<bpel:sequence name="ExistingPatient">
				<bpel:assign validate="no" name="Assign-PatientID">
					<bpel:copy>
						<bpel:from part="PatientIDsList" variable="GetPatientIDResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID[1]]]></bpel:query>
						</bpel:from>
						<bpel:to part="Order" variable="OrderRadiologyExamRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="PatientIDsList" variable="GetPatientIDResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID[1]]]></bpel:query>
						</bpel:from>
						<bpel:to part="LabOrder" variable="OrderLabTestRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
			</bpel:sequence>
			<bpel:else>
				<bpel:sequence name="NewPatient">
                    <bpel:invoke name="Invoke-CreatePatient" partnerLink="PatService" operation="CreatePatientRecord" 
                                 portType="pat:ElectronicPatientRecord" inputVariable="CreatePatientRequest" 
                                 outputVariable="CreatePatientResponse" />
                    <bpel:assign validate="no" name="Assign-PatientID">
                        <bpel:copy>
                            <bpel:from part="PatientID" variable="CreatePatientResponse"></bpel:from>
                            <bpel:to part="LabOrder" variable="OrderLabTestRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[PatientID]]>
                                </bpel:query>
                            </bpel:to>
                        </bpel:copy>
                        <bpel:copy>
                            <bpel:from part="PatientID" variable="CreatePatientResponse"></bpel:from>
                            <bpel:to part="Order" variable="OrderRadiologyExamRequest">
                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
                            </bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                </bpel:sequence>
			</bpel:else>
		</bpel:if>
        <bpel:flow name="Flow-Examination">
			<bpel:sequence name="Radiology">
				<bpel:invoke name="Invoke-RadiologyExam" partnerLink="RadService"
					         operation="OrderRadiologyExamination" portType="rad:Radiology"
					         inputVariable="OrderRadiologyExamRequest" outputVariable="OrderRadiologyExamResponse" />
				<bpel:assign validate="no" name="Assign-RadiologyOrder">
					<bpel:copy>
						<bpel:from part="RadiologyOrderID" variable="OrderRadiologyExamResponse"></bpel:from>
						<bpel:to part="RadiologyAppointmentRequest" variable="RadiologyAppointmentRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[OrderID]]>
                            </bpel:query>
                        </bpel:to>
					</bpel:copy>
                    <bpel:copy>
                        <bpel:from part="Order" variable="OrderRadiologyExamRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="PatientTransportOrder" variable="RadPatientTransportRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
				<bpel:invoke name="Invoke-RadiologyAppointment"
                             partnerLink="RadService" operation="RequestAppointment" portType="rad:Radiology"
                             inputVariable="RadiologyAppointmentRequest" outputVariable="RadiologyAppointmentResponse" />
				<bpel:invoke name="Invoke-TransportPatient" partnerLink="TranspService"
				             operation="OrderPatientTransport" inputVariable="RadPatientTransportRequest" />
				<bpel:receive name="Receive-RadiologyReport" partnerLink="RadService" 
				              operation="SendRadiologyReport" variable="RadiologyReportResponse" />
                <bpel:assign validate="no" name="Assign-RadiologyReport">
                    <bpel:copy>
                        <bpel:from part="RadiologyReport" variable="RadiologyReportResponse" />
                        <bpel:to part="RadiologyReport" variable="StoreRadiologyReportRequest" />
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="Invoke-StoreReport" partnerLink="PatService"
                             operation="StoreRadiologyReport" portType="pat:ElectronicPatientRecord"
                             inputVariable="StoreRadiologyReportRequest" />
			</bpel:sequence>
			<bpel:sequence name="Laboratory">
				<bpel:invoke name="Invoke-OrderLabTest" partnerLink="LabService"
                             operation="OrderLabTest" portType="lab:Laboratory" inputVariable="OrderLabTestRequest"
                             outputVariable="OrderLabTestResponse" />
                <bpel:assign validate="no" name="Assign-LaboratoryOrder">
                    <bpel:copy>
                        <bpel:from part="LabOrder" variable="OrderLabTestRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="SampleTransportOrder" variable="LabSampleTransportRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[PatientID]]>
                            </bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="Invoke-OrderSampleTransport"
					         partnerLink="TranspService" operation="OrderSampleTransport"
					         portType="ts:Transportation" inputVariable="LabSampleTransportRequest" />
				<bpel:receive name="Receive-LabReport" partnerLink="LabService"
				              operation="SendLabReport" variable="LabReportResponse" />
                <bpel:assign validate="no" name="Assign-LabReport">
                    <bpel:copy>
                        <bpel:from part="LabReport" variable="LabReportResponse" />
                        <bpel:to part="LabReport" variable="StoreLabReportRequest" />
                    </bpel:copy>
                </bpel:assign>
                <bpel:invoke name="Invoke-StoreReport" partnerLink="PatService"
					         operation="StoreLabReport" portType="pat:ElectronicPatientRecord"
					         inputVariable="StoreLabReportRequest" />
			</bpel:sequence>
		</bpel:flow>
        <bpel:flow name="Flow-Review">
        	<bpel:sequence name="ReviewReports">
            	<bpel:receive name="Receive-DischargeLetter" partnerLink="WardService" 
            	              operation="ReceiveDischargeLetter" portType="ward:Ward" variable="WardServiceReceiveDischargeLetter" />
            </bpel:sequence>
            <bpel:sequence name="Payment">
                <bpel:receive name="Receive-Payment" partnerLink="WardService" operation="ReceivePayment" 
                              portType="ward:Ward" variable="WardServicePaymentRequest" />
            </bpel:sequence>
        </bpel:flow>
        <bpel:assign validate="no" name="Assign-DischargeLetter">
            <bpel:copy>
                <bpel:from part="DischargeLetter" variable="WardServiceReceiveDischargeLetter" />
                <bpel:to part="DischargeLetter" variable="WardServiceResponse" />
            </bpel:copy>
        </bpel:assign>
        <bpel:reply name="Reply-DischargeLetter" partnerLink="WardService"
			        operation="OrderPatientTreatment" variable="WardServiceResponse" />
	</bpel:sequence>
</bpel:process>